(function(){"use strict";var e={4158:function(e,t,s){var i=s(9963),o=s(6252);const n=e=>((0,o.dD)("data-v-340def46"),e=e(),(0,o.Cn)(),e),a={id:"level"},r=n((()=>(0,o._)("canvas",{id:"canvas"},null,-1))),h={key:0,id:"loading_overlay"},l=n((()=>(0,o._)("div",{id:"loading_overlay_text"},"Loading...",-1))),d=[l];function c(e,t,s,i,n,l){const c=(0,o.up)("TopBar"),m=(0,o.up)("MenuLevel"),u=(0,o.up)("Settings"),p=(0,o.up)("LevelPreview");return(0,o.wg)(),(0,o.iD)("div",null,[(0,o._)("div",a,[r,(0,o.Wm)(c),(0,o.Wm)(m),(0,o.Wm)(u),this.$store.state.level.loading?((0,o.wg)(),(0,o.iD)("div",h,d)):(0,o.kq)("",!0),(0,o.Wm)(p)])])}var m=s(7327),u=s(1400),p=(s(9962),s(9520),s(3907));const y={SET_PRESS_MOVE_RIGHT(e,t){e.right=t},SET_PRESS_MOVE_LEFT(e,t){e.left=t},SET_PRESS_MOVE_UP(e,t){e.up=t},SET_PRESS_MOVE_DOWN(e,t){e.down=t},SET_MOVE_LAST_EVENT(e,t){e.lastEvent=t},SET_IS_USED_MOVE_CONTROLLER(e,t){e.isUsed=t}},v={right:!1,left:!1,up:!1,down:!1,lastEvent:"",isUsed:!1},g={controllerMoveIsUsed:e=>e.isUsed},b={state:v,mutations:y,getters:g},f={SET_PRESS_ROTATE_RIGHT(e,t){e.right=t},SET_PRESS_ROTATE_LEFT(e,t){e.left=t},SET_PRESS_ROTATE_UP(e,t){e.up=t},SET_PRESS_ROTATE_DOWN(e,t){e.down=t},SET_ROTATE_LAST_EVENT(e,t){e.lastEvent=t},SET_IS_USED_ROTATE_CONTROLLER(e,t){e.isUsed=t}},I={right:!1,left:!1,up:!1,down:!1,lastEvent:"",isUsed:!1},E={state:I,mutations:f},w={fields:[{name:"music",value:!0,label:"Music"},{name:"sound",value:!0,label:"Sound"},{name:"dev_mode",value:!1,label:"Dev mode"}],validateFieldName(e){const t=this.fields.find((t=>t.name==e));if(!t)throw"Error setting field";return!0},setValueByName(e,t){this.validateFieldName(e);const s=this.getFields(),i=s.map((s=>(s.name==e&&(s.value=t),s)));return localStorage.setItem("settings",JSON.stringify(i)),!0},getValueByName(e){const t=this.getFields(),s=t.find((t=>t.name==e));if(!s)throw"Error setting field";return s.value},getFields(){const e=localStorage.getItem("settings");if(e){const t=JSON.parse(String(e));return this.fields.map((e=>{const s=t.find((t=>t.name==e.name));return s&&(e.value=s.value),e}))}return this.fields}},_={SET_SETTINGS_OPEN(e,t){e.open=t},SET_SETTING_FIELD_VALUE(e,t){w.validateFieldName(t.name)&&(w.setValueByName(t.name,t.value),e.fields.forEach((e=>{e.name===t.name&&(e.value=t.value)})))}},T={fields:w.getFields(),open:!1},S={settingFields:e=>e.fields,getSettingsFieldByName:e=>t=>e.fields.find((e=>e.name==t)),getSettingsValueByName:e=>t=>{const s=e.fields.find((e=>e.name==t));if(!s)throw"Error setting field in Store state";return s.value}},A={state:T,mutations:_,getters:S};s(7658);const C={saveCompletedLevel(e){if(!this.checkCompletedLevelId(e)){const t=this.getCompletedLevelsIds();t.push(String(e)),localStorage.setItem("completedLevelsIds",t.join(","))}this.setLastCompletedLevelId(String(e))},getCompletedLevelsIds(){const e=localStorage.getItem("completedLevelsIds");return e?e.split(","):[]},getLastCompletedLevelId(){return Number(localStorage.getItem("lastCompletedLevelsId"))},setLastCompletedLevelId(e){return localStorage.setItem("lastCompletedLevelsId",e)},checkCompletedLevelId(e){const t=this.getCompletedLevelsIds();return t.find((t=>t==e))}},F={SET_LEVEL(e,t){e.levelId=t},SET_PLAY(e){e.play=!0},SET_OPEN_MENU(e,t){e.isMenuOpen=t},SET_DATE_LAST_USED_CONTROLLERS(e,t){e.dateLastUsedControllers=t},SET_IS_USED_CONTROLLERS(e,t){e.isUsedControllers=t},MAP_TOGGLE(e){e.isMapOpen=!e.isMapOpen},LOADING_TOGGLE(e){e.loading=!e.loading},SET_LOWER_FLOOR_POSITION(e,t){e.lowerFloorPosition.x=t.x,e.lowerFloorPosition.y=t.y,e.lowerFloorPosition.z=t.z},SET_LOWER_FLOOR_SIZE(e,t){e.lowerFloorSize.width=t.width,e.lowerFloorSize.height=t.height},ADD_KEY(e,t){e.keys.push(t)},SET_ACTIVE_KEY(e,t){const s=e.keys.find((e=>e.id==t));s&&(s.status=!0),e.keysActiveCount=e.keys.filter((e=>e.status)).length},CHARGE_BATTERY_UP(e,t){e.batteryCharge<100&&(e.batteryCharge+t<=100?e.batteryCharge+=t:e.batteryCharge=100)},CHARGE_BATTERY_DOWN(e,t){0!=e.batteryCharge&&(e.batteryCharge-t>=0?e.batteryCharge-=t:e.batteryCharge=0)},SET_FINISH(e){C.saveCompletedLevel(e.levelId),e.finish=!0}},L={levelId:0,play:!1,loading:!0,dateLastUsedControllers:0,isUsedControllers:!1,isMapOpen:!1,isMenuOpen:!1,playerPosition:{x:0,y:0,z:0},playerRotate:{x:0,y:0},lowerFloorPosition:{x:0,y:0,z:0},lowerFloorSize:{width:0,height:0},keys:[],keysActiveCount:0,batteryCharge:0,finish:!1},P={batteryCharge:e=>e.batteryCharge,finish:e=>e.finish},M={state:L,mutations:F,getters:P},B=(e,t)=>e.list.find((e=>e.id==t)),Z={id:"new",character:"",items:[],properties:[],move:{forward:{front:!1,back:!1,left:!1,right:!1,isMoving:!1,sprint:!1},rotate:{x:0,y:0},jump:!1,isFly:!1,isFlyUp:!1,syncData:{position:{x:0,y:0,z:0},rotation:{x:0,y:0}}},event:{press:!1,isFocused:!1}},N={ADD_PLAYER(e,t){if(!B(e,t.id)){const s=JSON.parse(JSON.stringify(Z));s.id=t.id,s.character="BTLMN_Lemon.gltf",s.items=t.items,s.properties=t.properties,e.list.push(s)}},REMOVE_PLAYER(e,t){e.list.splice(e.list.findIndex((e=>e.id==t)),1)},FLY_ENABLED(e,t){B(e,t).move.isFly=!0},FLY_UP_ENABLED(e,t){B(e,t).move.isFlyUp=!0},FLY_UP_DISABLED(e,t){B(e,t).move.isFlyUp=!1},FLY_DISABLED(e,t){B(e,t).move.isFly=!1},SET_FORWARD(e,t){B(e,t.playerId).move.forward={...t.forward}},UPDATE_ROTATE(e,t){B(e,t.playerId).move.rotate=t.rotate},UPDATE_ROTATION(e,t){const s=B(e,t.playerId);s.move.syncData.rotation.x=t.x,s.move.syncData.rotation.y=t.y},UPDATE_POSITION(e,t){B(e,t.playerId).move.syncData.position=t.position},JUMP_DISABLED(e,t){B(e,t).move.jump=!1},JUMP_ENABLED(e,t){B(e,t).move.jump=!0},JUMP_SET(e,t){B(e,t.playerId).move.jump=t.jump},SYNC_PLAYER(e,t){const s=B(e,t.id);s&&(s.move=t.move)},SET_EVENT_PRESS(e,t){const s=B(e,t.playerId);s.event.press=t.status},SET_EVENT_IS_FOCUSED(e,t){const s=B(e,t.playerId);s.event.isFocused=t.status}},R={list:[]},O={getPlayerById:e=>t=>e.list.find((e=>e.id===t))},x={state:R,mutations:N,getters:O},D={strict:!1,state:{player:{id:""},levels:[{id:1,finish:!1},{id:2,finish:!1},{id:3,finish:!1}]},mutations:{SET_SELF_PLAYER_ID(e,t){e.player.id=t}},modules:{players:x,controllerMove:b,controllerRotate:E,level:M,settings:A}};var k=new p.ZP.Store(D);class G{constructor(){(0,m.Z)(this,"shadowGenerator",void 0),(0,m.Z)(this,"scene",void 0),this.scene=globalThis.scene,this.shadowGenerator=null}setupHDR(){const e="/game/resources/graphics/textures/environment.env",t=u.CubeTexture.CreateFromPrefilteredData(e,this.scene),s=0;t.setReflectionTextureMatrix(u.Matrix.RotationY(u.Tools.ToRadians(s))),t.gammaSpace=!1,this.scene.environmentTexture=t}setupGlow(){const e=new u.GlowLayer("glow",this.scene,{mainTextureFixedSize:1054,blurKernelSize:70});e.intensity=.4}setupFog(){this.scene.fogColor=new u.Color3(0,0,0),this.scene.fogDensity=.04,this.scene.fogMode=u.Scene.FOGMODE_EXP}setupLightAndShadow(){const e=this.scene.getLightById("MainDirectionLight");e?this.shadowGenerator=new u.ShadowGenerator(2064,e):console.info("Add a light with the ID MainDirectionLight to display the shadow")}}var U=s(6154);const V={getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e},get2DCoordinatesFromMesh(e,t,s,i){const o=u.Vector3.Project(e.getAbsolutePosition(),u.Matrix.IdentityReadOnly,s.getTransformMatrix(),t.viewport.toGlobal(i.getRenderWidth(),i.getRenderHeight()));return{top:o.y,left:o.x}},getIsSuffix(e,t){const s=e.id.split("_");return!(!s.length||!s.find((e=>e===t)))},IsName(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return e===t||!!s&&-1!==e.search(t)},getMeshesByName(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return globalThis.scene.meshes.filter((s=>V.IsName(s.name,e,t)))},getMeshByName(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return e.meshes.find((e=>V.IsName(e.name,t,s)))},getTime(){const e=new Date;return e.getTime()},getAverage(){const e=new u.RollingAverage(60);return e.add(scene.getAnimationRatio()),e.average},numberFixed(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;return Number(Number(e).toFixed(t))},getNameId(e){return e.split(".")[1]},drawEllipsoid(e){const t=e.getScene(),s=u.MeshBuilder.CreateSphere("debug",{diameterX:2*e.ellipsoid.x,diameterY:2*e.ellipsoid.y,diameterZ:2*e.ellipsoid.z,segments:16},t);t.onBeforeRenderObservable.add((()=>{s.position.copyFrom(e.position),s.position.addInPlace(e.ellipsoidOffset)}));const i=new u.StandardMaterial("debugmat",e.getScene());i.diffuseColor=new u.Color3(0,1,0),i.wireframe=!0,s.material=i},isFile(e){if(e){const t=e.split("/");if(t){const e=t.pop();if(e)return e.indexOf(".")>0}}return!1},async getFileTimestamp(e){const t=e.split("/"),s=t[t.length-2]+"/"+t[t.length-1];try{const e=await U.Z.get("/game/resources/graphics/manifest.json"),t=e.data;return t[s]??(new Date).getTime()}catch(i){return console.error("Ошибка получения manifest.json:",i),e}},getTagsFromMesh(e){const t=u.Tags.GetTags(e);return t&&t.length?t.split(" "):null},hasTag(e,t){const s=this.getTagsFromMesh(e);return!!s&&void 0!==s.find((e=>e===t))}};class z{constructor(e){(0,m.Z)(this,"scene",void 0),(0,m.Z)(this,"engine",void 0),(0,m.Z)(this,"store",void 0),this.scene=new u.Scene(e),globalThis.scene=this.scene,this.store=k,this.engine=e}async load(e){window.addEventListener("resize",(()=>{this.engine.resize()})),u.SceneLoader.CleanBoneMatrixWeights=!0,u.SceneLoader.ShowLoadingScreen=!1;const t="map.babylon",s="/game/resources/graphics/level_"+this.store.state.level.levelId+"/",i=await V.getFileTimestamp(s+t),o=t+"?timestamp="+i;u.SceneLoader.Append(s,o,this.scene,(t=>{try{e()}catch(s){console.error(s)}this.optimize(t),this.engine.runRenderLoop((()=>{this.scene.render()}))}),null,((e,t,s)=>{console.log(s,t)}))}optimize(e){e.autoClearDepthAndStencil=!1;const t=e.getMeshesByTags("notAnimate");t.forEach((e=>{e.freezeWorldMatrix(),e.doNotSyncBoundingInfo=!0,e.cullingStrategy=u.AbstractMesh.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY}));const s=new u.SceneOptimizerOptions(60,1e3),i=new u.SceneOptimizer(e,s);i.start()}setEnvironment(){const e=new G;e.setupHDR(),e.setupGlow(),e.setupLightAndShadow()}}class Y{constructor(){(0,m.Z)(this,"path",void 0),this.path="/game/resources/audio"}subscribe(e,t,s){e.subscribe((i=>{"SET_SETTING_FIELD_VALUE"==i.type&&i.payload.name==s&&(e.getters.getSettingsValueByName(s)?t&&!t.isPlaying&&t.play():t&&t.isPlaying&&t.stop())}))}}class j extends Y{constructor(){super(),(0,m.Z)(this,"filePath",void 0),(0,m.Z)(this,"sound",void 0),(0,m.Z)(this,"store",void 0),this.store=k,this.filePath=this.path+"/level_"+this.store.state.level.levelId+"/music.wav",this.sound=new u.Sound("Music",this.filePath,globalThis.scene,(()=>{this.subscribe(k,this.sound,"music")}),{loop:!0,autoplay:k.getters.getSettingsValueByName("music"),volume:.5})}}class H extends Y{constructor(){super(),(0,m.Z)(this,"filePath",void 0),(0,m.Z)(this,"sound",void 0),this.filePath=this.path+"/cosmos.wav",this.sound=new u.Sound("Cosmos",this.filePath,globalThis.scene,(()=>{this.subscribe(k,this.sound,"sound")}),{loop:!0,autoplay:k.getters.getSettingsValueByName("sound")})}}class W{constructor(){(0,m.Z)(this,"music",void 0),(0,m.Z)(this,"isLevelRun",void 0),(0,m.Z)(this,"pathAudio",void 0),this.isLevelRun=!1,this.pathAudio="resources/audio";const e=u.Engine.audioEngine;e&&(e.useCustomUnlockedButton=!0,k.subscribe((t=>{if("SET_PLAY"==t.type&&!this.isLevelRun){const t=e.audioContext;t&&t.resume(),this.isLevelRun=!0,e.unlock(),new j,new H}})))}}var J=s(9898),K=s(6486);class ${constructor(e){(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"store",void 0),(0,m.Z)(this,"unsubscribes",void 0),this.playerId=e,this.store=k,this.unsubscribes=[],this.dispose()}move(e){let t={};const s=this.store.subscribe((()=>{const s=this.getPlayerById();if(!s)return null;const i=s.move,o=(0,K.isEqual)(t,i);o||(t={...i},e(i))}));this.unsubscribes.push({name:"move",unsubscribe:s})}forward(e){let t={left:!1,right:!1,front:!1,back:!1,isMoving:!1};const s=this.store.subscribe((()=>{const s=this.getPlayerById();if(!s)return null;const i=s.move.forward,o=(0,K.isEqual)(t,i);o||(t={...i},e(i))}));this.unsubscribes.push({name:"forward",unsubscribe:s})}jump(e){let t=!1;const s=this.store.subscribe((()=>{const s=this.getPlayerById();if(!s)return null;const i=s.move;t!==i.jump&&(t=i.jump,e(i.jump))}));this.unsubscribes.push({name:"jump",unsubscribe:s})}pressEvent(e){let t=!1;const s=this.store.subscribe((()=>{const s=this.getPlayerById();if(!s)return null;const i=s.event.press;t!==i&&(t=i,e(i))}));this.unsubscribes.push({name:"pressEvent",unsubscribe:s})}fly(e){let t=!0;const s=this.store.subscribe((()=>{const s=this.getPlayerById();if(!s)return null;const i=s.move;t!==i.isFly&&(t=i.isFly,i.isFly&&e(s))}));this.unsubscribes.push({name:"fly",unsubscribe:s})}flyEnd(e){let t=!0;const s=this.store.subscribe((()=>{const s=this.getPlayerById();if(!s)return null;const i=s.move;t!==i.isFly&&(t=i.isFly,i.isFly||e(s))}));this.unsubscribes.push({name:"flyEnd",unsubscribe:s})}rotate(e){const t={rotateX:0,rotateY:0},s=this.store.subscribe((()=>{const s=this.getPlayerById();if(!s)return null;const i=s.move;t.rotateX===i.rotate.x&&t.rotateY===i.rotate.y||(t.rotateX=i.rotate.x,t.rotateY=i.rotate.y,e(i.rotate.x,i.rotate.y))}));this.unsubscribes.push({name:"rotate",unsubscribe:s})}position(e){let t={x:0,y:0,z:0};const s=this.store.subscribe((()=>{const s=this.getPlayerById();if(!s)return null;const i=s.move,o=i.syncData.position;(0,K.isEqual)(o,t)||(t={...o},e(o))}));this.unsubscribes.push({name:"position",unsubscribe:s})}rotation(e){let t={x:0,y:0};const s=this.store.subscribe((()=>{const s=this.getPlayerById();if(!s)return null;const i=s.move,o=i.syncData.rotation;(0,K.isEqual)(o,t)||(t={...o},e(o))}));this.unsubscribes.push({name:"rotation",unsubscribe:s})}syncData(e){let t={};const s=this.store.subscribe((()=>{const s=this.getPlayerById();if(!s)return null;const i=s.move,o=i.syncData;(0,K.isEqual)(o,t)||(t={...o},e(o))}));this.unsubscribes.push({name:"syncData",unsubscribe:s})}syncPlayer(e){let t={};const s=this.store.subscribe((()=>{const s=this.getPlayerById();if(!s)return null;(0,K.isEqual)(s,t)||(t=JSON.parse(JSON.stringify(s)),e(s))}));this.unsubscribes.push({name:"syncPlayer",unsubscribe:s})}getPlayerById(){const e=k.getters.getPlayerById(this.playerId);return e||(console.info("SubscribeStore: not found state by playerId: "+this.playerId),this.unsubscribeAll()),e}dispose(){const e=this.store.subscribe((()=>{const e=k.getters.getPlayerById(this.playerId);e||this.unsubscribeAll()}));this.unsubscribes.push({name:"dispose",unsubscribe:e})}unsubscribeAll(){this.unsubscribes.forEach((e=>{e.unsubscribe()}))}}class q{constructor(e){(0,m.Z)(this,"sessionId",void 0),(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"room",void 0),(0,m.Z)(this,"subscribeStore",void 0),this.sessionId=null,this.room=null,this.playerId=e}init(){const e=new J.Client("wss://proxypass.battlemon.com");e.joinOrCreate("my_room").then((e=>{this.room=e,this.room.state.players.onAdd=e=>{k.commit("ADD_PLAYER",e)},this.room.state.players.onRemove=e=>{k.commit("REMOVE_PLAYER",e.id)},console.info("Joined to server room"),this.room.send("createPlayer",{playerId:this.playerId}),this.room.onMessage("syncPlayer",(e=>{k.commit("SYNC_PLAYER",e.player)})),this.room.onMessage("errorIdPlayer",(e=>{500===e&&alert("A player with this ID will not find!")}))}))}syncPlayer(){this.playerId&&this.room&&"undefined"!==typeof this.room&&(this.subscribeStore=new $(this.playerId),this.subscribeStore.syncPlayer((e=>{this.room?.send("syncPlayer",{playerId:this.playerId,player:e})})))}}class X{constructor(){w.getValueByName("dev_mode")&&this.enabled()}enabled(){const e=document.getElementsByTagName("body")[0];e&&scene.debugLayer.show({overlay:!0,globalRoot:e})}}class Q{constructor(e){(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"meshHeadId",void 0),(0,m.Z)(this,"meshFootId",void 0),(0,m.Z)(this,"observer",void 0),this.playerId=e,this.meshHeadId="playerHead_"+e,this.meshFootId="playerFoot_"+e,this.observer=null,this.add()}add(){const e=globalThis.scene,t=.5,s=u.MeshBuilder.CreateBox(this.meshHeadId,{size:t},e),i=u.MeshBuilder.CreateBox(this.meshFootId,{size:t},e);u.Tags.AddTagsTo(i,"foot"),i.ellipsoid=new u.Vector3(t/2,t,t/2),i.ellipsoidOffset=new u.Vector3(0,.3,0),s.rotation.x=0,s.rotation.z=0,i.position.y=10;const o=e.getMeshById("player");o&&(i.position.z=o.position.z,i.position.x=o.position.x),i.rotation=new u.Vector3,s.visibility=0,i.visibility=0,s.checkCollisions=!1,i.checkCollisions=!1,s.isPickable=!1,i.isPickable=!1,s.isPickable=!1,this.observer=e.onBeforeRenderObservable.add((()=>{s.position.x=i.position.x,s.position.y=i.position.y+2,s.position.z=i.position.z,s.rotation.y=i.rotation.y}))}dispose(){null!==this.observer&&scene.onBeforeRenderObservable.remove(this.observer)}}const ee=.07,te=.12,se=.08,ie=1.5;class oe{constructor(e,t){(0,m.Z)(this,"meshHead",void 0),(0,m.Z)(this,"meshFoot",void 0),(0,m.Z)(this,"speed",void 0),(0,m.Z)(this,"scene",void 0),(0,m.Z)(this,"footIsCollision",void 0),(0,m.Z)(this,"jumpAnimation",void 0),(0,m.Z)(this,"animationJumpFrames",void 0),(0,m.Z)(this,"modelCollisions",void 0),(0,m.Z)(this,"store",void 0),(0,m.Z)(this,"forward",void 0),(0,m.Z)(this,"fly",void 0),(0,m.Z)(this,"flyUp",void 0),(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"flyModeTimerId",void 0),(0,m.Z)(this,"observerBefore",void 0),(0,m.Z)(this,"observerAfter",void 0),(0,m.Z)(this,"rollingAverage",void 0),this.scene=t,this.store=k,this.meshFoot=this.scene.getMeshById("playerFoot_"+e),this.meshHead=this.scene.getMeshById("playerHead_"+e),this.modelCollisions=globalThis.collisions,this.fly=!0,this.flyModeTimerId=0,this.flyUp=!1,this.playerId=e,this.animationJumpFrames=55,this.footIsCollision=!1,this.jumpAnimation=!1,this.rollingAverage=new u.RollingAverage(60),this.forward={left:!1,right:!1,front:!1,back:!1,isMoving:!1,sprint:!1},this.speed=ee,this.createJumpAnimation(),this.observerBefore=this.scene.onBeforeRenderObservable.add((()=>{this.beforeRender()})),this.observerAfter=this.scene.onAfterRenderObservable.add((()=>{this.afterRender()}))}createJumpAnimation(){this.jumpAnimation=new u.Animation("jump","position.y",100,u.Animation.ANIMATIONTYPE_FLOAT,u.Animation.ANIMATIONLOOPMODE_CYCLE);const e=new u.SineEase;e.setEasingMode(u.EasingFunction.EASINGMODE_EASEOUT),this.jumpAnimation.setEasingFunction(e)}setAverage(){this.rollingAverage.add(this.scene.getAnimationRatio())}move(){if(!this.forward.isMoving)return null;this.changeSpeed();const e=u.Vector3.Zero(),t=this.rollingAverage.average;this.forward.front&&(e.z=V.numberFixed(t*this.speed)),this.forward.back&&(e.z=V.numberFixed(t*-this.speed)),this.forward.left&&(e.x=V.numberFixed(t*-this.speed)),this.forward.right&&(e.x=V.numberFixed(t*this.speed)),this.setNewPosition(e)}gravity(){if(this.footIsCollision)clearTimeout(this.flyModeTimerId),this.flyModeTimerId=0,this.fly&&(this.fly=!1);else{const e=u.Vector3.Zero();e.y=V.numberFixed(this.rollingAverage.average*-se,4),this.setNewPosition(e),this.fly||this.flyModeTimerId||(this.flyModeTimerId=setTimeout((()=>{this.fly=!0}),100))}}jump(){if("object"===typeof this.jumpAnimation){if(this.footIsCollision){const e=[{frame:0,value:this.meshFoot.position.y},{frame:this.animationJumpFrames,value:this.meshFoot.position.y+ie}];this.jumpAnimation.setKeys(e),this.meshFoot.animations=[this.jumpAnimation],this.flyUp=!0,this.scene.beginDirectAnimation(this.meshFoot,[this.jumpAnimation],0,this.animationJumpFrames,!1,1.8,(()=>{this.flyUp=!1}))}}else console.error("Jump not set animation")}setNewPosition(e){const t=this.meshFoot.getWorldMatrix(),s=u.Vector3.TransformNormal(e,t);this.meshFoot.moveWithCollisions(s)}rotate(e,t){this.meshHead.rotation.x+=e,this.meshFoot.rotation.y+=t,this.meshHead.rotation.x>u.Tools.ToRadians(90)&&(this.meshHead.rotation.x=u.Tools.ToRadians(90)),this.meshHead.rotation.x<-u.Tools.ToRadians(45)&&(this.meshHead.rotation.x=-u.Tools.ToRadians(45))}changeSpeed(){this.speed=this.forward.sprint?te:ee}beforeRender(){this.setAverage(),this.footIsCollision=this.modelCollisions.checkCollisionFloor(this.meshFoot),this.move()}afterRender(){this.footIsCollision=this.modelCollisions.checkCollisionFloor(this.meshFoot),this.gravity()}dispose(){this.observerBefore&&this.scene.onBeforeRenderObservable.remove(this.observerBefore),this.observerAfter&&this.scene.onBeforeRenderObservable.remove(this.observerAfter)}}class ne extends oe{constructor(e,t){super(e,t),this.updatePositionToState(),this.updateRotationToState(),this.updateFly()}updatePositionToState(){let e={x:this.meshFoot.position.x,y:this.meshFoot.position.y,z:this.meshFoot.position.z};setInterval((()=>{const t={x:this.meshFoot.position.x,y:this.meshFoot.position.y,z:this.meshFoot.position.z};(0,K.isEqual)(e,t)||(this.store.commit("UPDATE_POSITION",{playerId:this.playerId,position:t}),e={...t})}),100)}updateRotationToState(){let e={x:this.meshFoot.rotation.x,y:this.meshFoot.rotation.y};setInterval((()=>{const t={x:this.meshFoot.rotation.x,y:this.meshFoot.rotation.y};if(!(0,K.isEqual)(t,e)){const s={playerId:this.playerId,x:t.x,y:t.y};this.store.commit("UPDATE_ROTATION",s),e={...t}}}),100)}updateFly(){let e=!1,t=!1;this.scene.onBeforeRenderObservable.add((()=>{e!==this.fly&&(this.fly?this.store.commit("FLY_ENABLED",this.playerId):(this.store.commit("FLY_DISABLED",this.playerId),this.store.commit("JUMP_DISABLED",this.playerId)),e=this.fly),t!==this.flyUp&&(this.flyUp?this.store.commit("FLY_UP_ENABLED",this.playerId):this.store.commit("FLY_UP_DISABLED",this.playerId),t=this.flyUp)}))}}class ae{constructor(){(0,m.Z)(this,"sensitiveMouse",void 0),(0,m.Z)(this,"mouseIsCaptured",void 0),(0,m.Z)(this,"store",void 0),(0,m.Z)(this,"scene",void 0),(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"move",void 0),this.sensitiveMouse=.002,this.mouseIsCaptured=!1,this.scene=globalThis.scene,this.store=k,this.playerId=k.state.player.id,this.move=new ne(this.playerId,scene),this.mouseEvent(),this.scene.onKeyboardObservable.add((e=>{this.keyEvent(e)}))}keyEvent(e){const t=k.getters.getPlayerById(this.playerId),s=t.move,i=e.event.code,o=e.type;let n=!1;u.KeyboardEventTypes.KEYDOWN===o&&("KeyW"===i&&(this.move.forward.front=!0),"KeyS"===i&&(this.move.forward.back=!0),"KeyA"===i&&(this.move.forward.left=!0),"KeyD"===i&&(this.move.forward.right=!0),"Space"===i&&(n=!0),"ShiftLeft"===i&&(this.move.forward.sprint=!0),"KeyE"===i&&this.store.commit("SET_EVENT_PRESS",{playerId:this.playerId,status:!0})),u.KeyboardEventTypes.KEYUP===o&&("KeyW"===i&&(this.move.forward.front=!1),"KeyS"===i&&(this.move.forward.back=!1),"KeyA"===i&&(this.move.forward.left=!1),"KeyD"===i&&(this.move.forward.right=!1),"Space"===i&&this.store.commit("JUMP_DISABLED",this.playerId),"ShiftLeft"===i&&(this.move.forward.sprint=!1),"KeyE"===i&&this.store.commit("SET_EVENT_PRESS",{playerId:this.playerId,status:!1})),this.move.forward.isMoving=!(!this.move.forward.left&&!this.move.forward.right&&!this.move.forward.back&&!this.move.forward.front);const a=(0,K.isEqual)(this.move.forward,s.forward);a||this.store.commit("SET_FORWARD",{playerId:this.playerId,forward:{...this.move.forward}}),n&&!this.move.fly&&(this.move.jump(),this.store.commit("JUMP_ENABLED",this.playerId))}mouseEvent(){const e=document.getElementById("level");e.addEventListener("click",(e=>{const t=e.composedPath().find((e=>{const t=e;return void 0!==t.tagName&&t.classList.contains("no_focus_game")}));if(!t){this.mouseIsCaptured=!0;const e=document.getElementById("canvas");e&&e.requestPointerLock()}}));const t=()=>{this.mouseIsCaptured=document.pointerLockElement||!1};document.addEventListener("pointerlockchange",t,!1),window.addEventListener("pointermove",(e=>{if(this.mouseIsCaptured){const t=e.movementY*this.sensitiveMouse,s=e.movementX*this.sensitiveMouse;this.move.rotate(t,s),this.store.commit("UPDATE_ROTATE",{playerId:this.playerId,rotate:{x:t,y:s}})}}))}}class re{constructor(e){(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"animation",void 0),(0,m.Z)(this,"weight",void 0),(0,m.Z)(this,"autoPlayLoop",void 0),(0,m.Z)(this,"scene",void 0),this.playerId=e,this.weight=1,this.autoPlayLoop=!0,this.scene=globalThis.scene,this.animation=this.scene.getAnimationGroupByName("Idle_"+e),this.setAnimations()}setAnimations(){this.animation?(this.animation.name="Idle_"+this.playerId,this.animation.setWeightForAllAnimatables(this.weight),this.animation.play(!0)):console.error("Not find Idle animation")}}class he{constructor(e){(0,m.Z)(this,"animation",void 0),(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"weight",void 0),(0,m.Z)(this,"autoPlayLoop",void 0),(0,m.Z)(this,"scene",void 0),this.playerId=e,this.weight=0,this.autoPlayLoop=!0,this.scene=globalThis.scene,this.animation=this.scene.getAnimationGroupByName("Run_"+e),this.setAnimations()}setAnimations(){null!==this.animation?(this.animation.name="Run_"+this.playerId,this.animation.setWeightForAllAnimatables(this.weight),this.animation.play(!0)):console.error("Not find Run animation")}}class le{constructor(e){(0,m.Z)(this,"animation",void 0),(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"weight",void 0),(0,m.Z)(this,"autoPlayLoop",void 0),(0,m.Z)(this,"scene",void 0),this.playerId=e,this.weight=0,this.autoPlayLoop=!0,this.scene=globalThis.scene,this.animation=this.scene.getAnimationGroupByName("JumpMiddle_"+e),this.setAnimations()}setAnimations(){this.animation?(this.animation.name="JumpMiddle_"+this.playerId,this.animation.setWeightForAllAnimatables(this.weight),this.animation.play(!0)):console.error("Not find JumpMiddle animation")}}class de{constructor(e){(0,m.Z)(this,"animation",void 0),(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"weight",void 0),(0,m.Z)(this,"autoPlayLoop",void 0),(0,m.Z)(this,"scene",void 0),this.playerId=e,this.weight=0,this.autoPlayLoop=!1,this.scene=globalThis.scene,this.animation=this.scene.getAnimationGroupByName("JumpFinish_"+e),this.setAnimations()}setAnimations(){this.animation?(this.animation.name="JumpFinish_"+this.playerId,this.animation.setWeightForAllAnimatables(this.weight),this.animation.stop()):console.error("Not find JumpFinish animation")}}class ce{constructor(e){(0,m.Z)(this,"animation",void 0),(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"weight",void 0),(0,m.Z)(this,"autoPlayLoop",void 0),(0,m.Z)(this,"scene",void 0),this.playerId=e,this.weight=0,this.autoPlayLoop=!0,this.scene=globalThis.scene,this.animation=this.scene.getAnimationGroupByName("Sprint_"+e),this.setAnimations()}setAnimations(){null!==this.animation?(this.animation.name="Sprint_"+this.playerId,this.animation.setWeightForAllAnimatables(this.weight),this.animation.play(!0)):console.error("Not find Sprint animation")}}class me{constructor(e){(0,m.Z)(this,"animation",void 0),(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"weight",void 0),(0,m.Z)(this,"autoPlayLoop",void 0),(0,m.Z)(this,"scene",void 0),this.playerId=e,this.weight=0,this.autoPlayLoop=!0,this.scene=globalThis.scene,this.animation=this.scene.getAnimationGroupByName("Picking_"+e),this.setAnimations()}setAnimations(){this.animation?(this.animation.name="Picking_"+this.playerId,this.animation.setWeightForAllAnimatables(this.weight),this.animation.play(!0)):console.error("Not find Picking animation")}}class ue{constructor(e){(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"animationGroupCurrent",void 0),(0,m.Z)(this,"animationGroups",void 0),(0,m.Z)(this,"store",void 0),(0,m.Z)(this,"scene",void 0),(0,m.Z)(this,"observableBeforeAnimation",void 0),(0,m.Z)(this,"subscribeStore",void 0),this.playerId=e,this.store=k,this.scene=globalThis.scene,this.animationGroups=[],this.animationGroupCurrent=void 0,this.setAnimationGroups(),this.observableBeforeAnimation=()=>{this.onBeforeAnimation()}}setAnimationGroups(){const e=new re(this.playerId);this.pushAnimation(e),this.pushAnimation(new he(this.playerId)),this.pushAnimation(new ce(this.playerId)),this.pushAnimation(new le(this.playerId)),this.pushAnimation(new de(this.playerId)),this.pushAnimation(new me(this.playerId)),e.animation&&(this.animationGroupCurrent=this.getAnimationByName("Idle_"+this.playerId),this.subscribe())}pushAnimation(e){e.animation&&this.animationGroups.push(e)}getAnimationByName(e){return this.animationGroups.find((t=>t.animation&&t.animation.name.includes(e)))}subscribe(){this.subscribeStore=new $(this.playerId);const e=this.getAnimationByName("JumpMiddle_"+this.playerId),t=this.getAnimationByName("JumpFinish_"+this.playerId);if(this.subscribeStore.move((e=>{if(!e.isFly&&!e.jump){const e=this.getAnimationByState();e&&this.blending(e)}})),this.subscribeStore.fly((()=>{this.blending(e)})),t&&t.animation){this.subscribeStore.flyEnd((()=>{this.blending(t),t.animation&&t.animation.play()}));const e=t.animation.targetedAnimations[0].animation,s=new u.AnimationEvent(25,(()=>{const e=this.getAnimationByState();e&&this.blending(e)}));e.addEvent(s)}}getAnimationByState(){const e=k.getters.getPlayerById(this.playerId);if(!e)return null;const t=e.move,s=this.getAnimationByName("Idle_"+this.playerId),i=this.getAnimationByName("Run_"+this.playerId),o=this.getAnimationByName("Sprint_"+this.playerId),n=this.getAnimationByName("Picking_"+this.playerId);let a=s;return t.forward.isMoving&&(a=i,t.forward.sprint&&(a=o)),e.event.isFocused&&(a=n),a}blending(e){this.animationGroupCurrent!==e&&(this.scene.onBeforeAnimationsObservable.removeCallback(this.observableBeforeAnimation),this.animationGroupCurrent=e,this.scene.onBeforeAnimationsObservable.add(this.observableBeforeAnimation))}onBeforeAnimation(){if(this.animationGroupCurrent&&this.animationGroupCurrent.animation){const e=u.Scalar.Clamp(this.animationGroupCurrent.weight+.08,0,1);this.animationGroupCurrent.weight=Number(e.toFixed(2)),this.animationGroupCurrent.animation.setWeightForAllAnimatables(this.animationGroupCurrent.weight)}this.animationGroups.forEach((e=>{if(e.animation&&0!==e.weight&&e!==this.animationGroupCurrent){const t=u.Scalar.Clamp(e.weight-.08,0,1);e.weight=Number(t.toFixed(2)),e.animation.setWeightForAllAnimatables(e.weight),e.autoPlayLoop||0!==e.weight||e.animation.stop()}})),this.animationGroupCurrent&&1===this.animationGroupCurrent.weight&&this.scene.onBeforeAnimationsObservable.removeCallback(this.observableBeforeAnimation)}dispose(){this.scene.onBeforeAnimationsObservable.removeCallback(this.observableBeforeAnimation)}}class pe{constructor(e){(0,m.Z)(this,"animation",void 0),(0,m.Z)(this,"scene",void 0),(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"angle",void 0),(0,m.Z)(this,"meshCharacter",void 0),(0,m.Z)(this,"meshFoot",void 0),(0,m.Z)(this,"subscribeStore",void 0),(0,m.Z)(this,"animatable",void 0),(0,m.Z)(this,"forwardAngle",void 0),(0,m.Z)(this,"isAnimated",void 0),(0,m.Z)(this,"syncIntervalId",void 0),this.scene=globalThis.scene,this.playerId=e,this.angle=0,this.meshCharacter=this.scene.getMeshById("characterBody_"+this.playerId),this.meshFoot=this.scene.getMeshById("playerFoot_"+this.playerId),this.animation=void 0,this.animatable=void 0,this.isAnimated=!1,this.forwardAngle=0,this.setAnimation(),this.subscribe()}setAnimation(){this.animation=new u.Animation("rotateMesh","rotation.y",20,u.Animation.ANIMATIONTYPE_FLOAT);const e=new u.CubicEase;e.setEasingMode(u.EasingFunction.EASINGMODE_EASEINOUT),this.animation.setEasingFunction(e)}setAngle(){const e=k.getters.getPlayerById(this.playerId);if(!e)return null;const t=e.move.forward;if(!t.isMoving)return null;let s=0;t.left&&(s=270),t.right&&(s=90),t.front&&(s=0,t.left&&(s=305),t.right&&(s=45)),t.back&&(s=180,t.left&&(s=225),t.right&&(s=135));let i=u.Tools.ToRadians(s)+this.meshFoot.rotation.y;const o=this.meshCharacter.rotation.y,n=u.Tools.ToDegrees(o);s=u.Tools.ToDegrees(i);const a=(s-n+180)%360-180,r=a<-180?a+360:a;i=o+u.Tools.ToRadians(r);const h=Math.abs(i-o)/(Math.PI/180);h>10?this.isAnimated||(this.stopAnimation(),this.play(i,o),this.isAnimated=!0):this.meshCharacter.rotation.y=i}play(e,t){if(void 0===this.animation)return void console.error("Not set animation rotate");const s=[],i=10;s.push({frame:0,value:t}),s.push({frame:i,value:e}),this.animation.setKeys(s),this.meshCharacter.animations=[],this.meshCharacter.animations.push(this.animation),this.isAnimated=!0,this.animatable=this.scene.beginAnimation(this.meshCharacter,0,i,!1,1.15,(()=>{this.isAnimated=!1}))}subscribe(){this.subscribeStore=new $(this.playerId),this.subscribeStore.rotate((()=>{const e=k.getters.getPlayerById(this.playerId).move.forward;e.isMoving&&this.setAngle()})),this.subscribeStore.forward((()=>{this.setAngle()})),this.syncIntervalId=setInterval((()=>{this.setAngle()}),100)}stopAnimation(){void 0!==this.animatable&&this.animatable.stop()}dispose(){this.subscribeStore?.unsubscribeAll(),this.syncIntervalId&&clearInterval(this.syncIntervalId)}}class ye{static getLODs(e){const t=[];return e.forEach((e=>{const s=V.getTagsFromMesh(e);if(!s||!s.find((e=>"lod"===e)))return;const i=s.find((e=>-1!==e.indexOf("distance"))),o=i?Number(i.split("_")[1]):0;e.isVisible=!1,t.push({mesh:e,distance:o})})),(0,K.sortBy)(t,"distance").reverse()}static addLevels(e){const t=ye.getLODs(e);if(t.length){const e=t[0],s=e.mesh;s.useLODScreenCoverage=!1;for(let i=1;i<t.length;i++){const e=t[i];s.addLODLevel(e.distance,e.mesh)}e.mesh.addLODLevel(e.distance,null)}}static showOnlyMainLod(e){const t=ye.getLODs(e);t.length&&(t.forEach((e=>{e.mesh.isVisible=!1})),t[0].mesh.isVisible=!0)}}class ve{static async getContainer(e,t){const s=t+e;if(!V.isFile(s))return console.error("Not found file container: "+s),null;const i=globalThis.assetContainers.find((t=>t.name===e));if(i){const e=this.getInstance(i.data),t=e.rootNodes[0].getChildMeshes();return ye.showOnlyMainLod(t),globalThis.collisions.appendCollisionByMeshes(t),e}const o=await V.getFileTimestamp(s),n=await u.SceneLoader.LoadAssetContainerAsync(t,e+"?timestamp=2"+o,globalThis.scene);if(n){ye.addLevels(n.meshes),n.removeAllFromScene();const t={name:e,data:n};globalThis.assetContainers.push(t);const s=this.getInstance(t.data),i=s.rootNodes[0].getChildMeshes();return globalThis.collisions.appendCollisionByMeshes(i),ye.showOnlyMainLod(i),s}return null}static getInstance(e){const t=e.instantiateModelsToScene((e=>e),!1,{doNotInstantiate:!1}),s=t.rootNodes[0].getChildMeshes();return s.forEach((t=>{const s=e.meshes.find((e=>e.name===t.name));if(s){const e=u.Tags.GetTags(s);u.Tags.AddTagsTo(t,e)}})),t}}class ge{constructor(e){(0,m.Z)(this,"characterMeshes",void 0),(0,m.Z)(this,"placeholders",void 0),(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"scene",void 0),this.playerId=e,this.scene=globalThis.scene;const t=scene.getMeshById("characterBody_"+this.playerId);this.characterMeshes=t.getChildMeshes(),this.placeholders=[],this.setPlaceholders(),this.setItems()}setPlaceholders(){this.characterMeshes.forEach((e=>{V.IsName(e.id,"placeholder",!0)&&(e.isVisible=!1,this.placeholders.push(e))}))}setItems(){const e=k.getters.getPlayerById(this.playerId);e.items.forEach((e=>{const t=this.placeholders.find((t=>V.IsName(t.id,e.type,!0)));if(!t)return null;const s="/resources/graphics/items/",i=ve.getContainer(e.flavour+".gltf",s);return i?void 0:(console.error("Container item not load :"+e.flavour),null)}))}}class be{constructor(e){(0,m.Z)(this,"scene",void 0),(0,m.Z)(this,"mesh",void 0),(0,m.Z)(this,"meshFoot",void 0),(0,m.Z)(this,"meshBody",void 0),(0,m.Z)(this,"meshRoot",void 0),(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"meshBodyId",void 0),(0,m.Z)(this,"meshRootId",void 0),(0,m.Z)(this,"observer",void 0),(0,m.Z)(this,"animation",void 0),(0,m.Z)(this,"rotation",void 0),this.scene=globalThis.scene,this.playerId=e,this.meshFoot=this.scene.getMeshById("playerFoot_"+e),this.meshBodyId="characterBody_"+this.playerId,this.meshRootId="characterRoot_"+this.playerId}load(e){const t="/game/resources/graphics/characters/",s=ve.getContainer("BTLMN_Lemon.gltf",t);s.then((s=>{if(!s)throw"Not found container "+t+"BTLMN_Lemon.gltf";const i=s.rootNodes[0];i.id=this.meshRootId,s.rootNodes[0].getChildMeshes().forEach((e=>{if("Body"==e.name)return e.id=this.meshBodyId,void(e.name=this.meshBodyId);e.id=e.id+"_"+this.playerId,e.name=e.name+"_"+this.playerId})),s.animationGroups.forEach((e=>{e.name=e.name+"_"+this.playerId})),this.setMeshes(),this.setAnimations(),this.setItems(),this.setShadow(),e(),this.observer=this.scene.onBeforeRenderObservable.add((()=>{this.beforeRender()}))}))}setMeshes(){const e=this.scene.getMeshById(this.meshBodyId),t=this.scene.getMeshById(this.meshRootId);if(!e)throw"Not found mesh Player Body";if(!this.meshFoot)throw"Not found mesh Player Foot";if(!t)throw"Not found mesh Root";this.meshBody=e,this.meshBody.rotationQuaternion=null,this.meshBody.resetLocalMatrix(),this.meshBody.isVisible=!1,this.meshRoot=t,this.meshRoot.id=this.meshRoot.name,this.meshRoot.rotationQuaternion=null,this.meshRoot.resetLocalMatrix(),this.meshRoot.getChildMeshes().forEach((e=>{e.id=e.name,e.isPickable=!1,e.checkCollisions=!1})),this.disposeNotActiveProperties()}filterProperties(e){const t=k.getters.getPlayerById(this.playerId),s=t.properties;return!!V.IsName(e.name,"placeholder",!0)||s.find((t=>V.IsName(e.name,t.flavour,!0)))}disposeNotActiveProperties(){this.meshBody?.getChildMeshes().forEach((e=>{this.filterProperties(e)||e.dispose()}))}setItems(){new ge(this.playerId)}setAnimations(){this.animation=new ue(this.playerId),this.rotation=new pe(this.playerId)}setShadow(){const e=this.scene.getLightById("MainDirectionLight");if(e){const t=e.getShadowGenerator();this.meshBody&&t&&t.addShadowCaster(this.meshBody)}}beforeRender(){this.meshRoot&&this.meshFoot&&(this.meshRoot.position.x=this.meshFoot.position.x,this.meshRoot.position.z=this.meshFoot.position.z,this.meshRoot.position.y=this.meshFoot.position.y-.24)}dispose(){this.rotation?.dispose(),this.animation?.dispose(),this.observer&&this.scene.onBeforeRenderObservable.remove(this.observer),this.scene.getMeshById("characterRoot_"+this.playerId)?.dispose()}}const fe=4.5,Ie=.5;class Ee{constructor(){(0,m.Z)(this,"scene",void 0),(0,m.Z)(this,"babylonCamera",void 0),(0,m.Z)(this,"meshHead",void 0),(0,m.Z)(this,"actualDistance",void 0),(0,m.Z)(this,"calculateDistance",void 0),(0,m.Z)(this,"isMoving",void 0),this.scene=globalThis.scene,this.babylonCamera=new u.UniversalCamera("playerCamera",u.Vector3.Zero(),this.scene),this.meshHead=this.scene.getMeshById("playerHead_"+k.state.player.id),this.actualDistance=-fe,this.isMoving=!1,this.calculateDistance={amount:0,distance:0},this.init()}init(){this.babylonCamera.maxZ=350,this.babylonCamera.minZ=.2,this.babylonCamera.name="player",this.scene.activeCamera=this.babylonCamera,this.attachCamera(),this.setIsMovingInterval()}attachCamera(){this.scene.registerBeforeRender((()=>{this.setDistance(),this.babylonCamera.position=this.meshHead.position,this.babylonCamera.rotation.x=Number(u.Scalar.Lerp(this.babylonCamera.rotation.x,this.meshHead.rotation.x,.4).toFixed(5)),this.babylonCamera.rotation.y=Number(u.Scalar.Lerp(this.babylonCamera.rotation.y,this.meshHead.rotation.y,.25).toFixed(5)),this.actualDistance=Number(u.Scalar.Lerp(this.actualDistance,this.calculateDistance.distance,this.calculateDistance.amount).toFixed(5));const e=this.babylonCamera.getDirection(u.Axis.Z);this.babylonCamera.position.addInPlace(e.scaleInPlace(this.actualDistance));const t=this.babylonCamera.getDirection(u.Axis.Y);this.babylonCamera.position.addInPlace(t.scaleInPlace(-Ie))}))}setDistance(){const e=this.meshHead.position;let t=new u.Vector3(0,-Ie,-fe);const s=this.meshHead.getWorldMatrix();t=u.Vector3.TransformCoordinates(t,s);const i=u.Vector3.Normalize(t.subtract(e)),o=new u.Ray(e,i,fe),n=this.scene.pickWithRay(o,(e=>e.checkCollisions));let a=-fe,r=.02;this.isMoving&&(a=-fe-1.2),n&&n.pickedMesh&&(a=-(n.distance+.2),r=.5),this.calculateDistance.distance=a,this.calculateDistance.amount=r}setIsMovingInterval(){setInterval((()=>{this.isMoving=Ee.getIstMoving()}),100)}static getIstMoving(){const e=k.getters.getPlayerById(k.state.player.id);return e.move.forward.isMoving}}class we{constructor(e){(0,m.Z)(this,"scene",void 0),(0,m.Z)(this,"playerId",void 0),this.scene=globalThis.scene,this.playerId=e,new Q(this.playerId);const t=new be(this.playerId);t.load((()=>{new ae,new Ee}))}}class _e extends oe{}class Te{constructor(e){(0,m.Z)(this,"move",void 0),(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"subscribeStore",void 0),this.playerId=e,this.move=new _e(e,globalThis.scene),this.subscribeStore=new $(this.playerId)}subscribe(){if(!this.subscribeStore)return!1;this.subscribeStore.rotate(((e,t)=>{this.move.rotate(e,t)})),this.subscribeStore.forward((e=>{this.move.forward={...e}})),this.subscribeStore.jump((e=>{e&&this.move.jump()})),this.syncPosition(),this.syncRotation()}dispose(){this.subscribeStore?.unsubscribeAll(),this.move.dispose()}syncPosition(){if(!this.subscribeStore)return!1;let e=null;this.subscribeStore.position((t=>{e&&(this.move.scene.onBeforeRenderObservable.remove(e),e=null);const s=this.move.meshFoot,i=Number(t.x.toFixed(5)),o=Number(t.y.toFixed(5)),n=Number(t.z.toFixed(5)),a=Number(s.position.x.toFixed(5)),r=Number(s.position.y.toFixed(5)),h=Number(s.position.z.toFixed(5));this.move.forward.isMoving||i===a&&o===r&&n===h?e&&(this.move.scene.onBeforeRenderObservable.remove(e),e=null):e=this.move.scene.onBeforeRenderObservable.add((()=>{s.position.x=u.Scalar.Lerp(s.position.x,i,.4),s.position.y=u.Scalar.Lerp(s.position.y,o,.4),s.position.z=u.Scalar.Lerp(s.position.z,n,.4),e&&Number(s.position.x.toFixed(5))===i&&Number(s.position.y.toFixed(5))===o&&Number(s.position.z.toFixed(5))===n&&(this.move.scene.onBeforeRenderObservable.remove(e),e=null)}))}))}syncRotation(){let e=null;if(!this.subscribeStore)return!1;this.subscribeStore.rotation((t=>{e&&(this.move.scene.onBeforeRenderObservable.remove(e),e=null);const s=this.move.meshHead,i=this.move.meshFoot,o=Number(t.x.toFixed(5)),n=Number(t.y.toFixed(5)),a=Number(s.rotation.x.toFixed(5)),r=Number(i.rotation.y.toFixed(5));o!==a||n!==r?e=this.move.scene.onBeforeRenderObservable.add((()=>{s.rotation.x=u.Scalar.Lerp(s.rotation.x,o,.4),i.rotation.y=u.Scalar.Lerp(i.rotation.y,n,.4),e&&Number(i.rotation.x.toFixed(5))===o&&Number(i.rotation.y.toFixed(5))===n&&(this.move.scene.onBeforeRenderObservable.remove(e),e=null)})):e&&(this.move.scene.onBeforeRenderObservable.remove(e),e=null)}))}}class Se{constructor(e){(0,m.Z)(this,"body",void 0),(0,m.Z)(this,"character",void 0),(0,m.Z)(this,"controller",void 0),(0,m.Z)(this,"playerId",void 0),this.playerId=e,this.body=new Q(e),this.character=new be(e),this.character.load((()=>{this.controller=new Te(e),this.controller.subscribe()}))}dispose(){console.log("try desp"),this.controller?.dispose(),this.character.dispose(),this.body.dispose()}}var Ae=s(5934);class Ce{constructor(e){(0,m.Z)(this,"prefabs",void 0),(0,m.Z)(this,"scene",void 0),this.scene=globalThis.scene,this.prefabs=[],this.setPrefabs(),this.setItems().then((()=>{console.info("All prefabs loaded!"),e()}))}setPrefabs(){const e=this.scene.getMeshesByTags("prefab");e.forEach((e=>{e.isVisible=!1,this.prefabs.push(e)}))}async setItems(){let e=0;globalThis.prefabs=[];for(const s of this.prefabs){const i=`BTLMN_Prop_${s.id.replace("Prefab_","").replace(/\.[^/.]+$/,"")}.gltf`,o="/game/resources/graphics/prefabs/";try{const t=await ve.getContainer(i,o);if(!t){console.error(`Error loading container ${i}:`);continue}const n=t.rootNodes[0];n.parent=s,s.id="prefab_"+e;const a=t.animationGroups.find((e=>"start"===e.name));a&&a.play(!0),globalThis.prefabs.push({id:e,container:t}),e++}catch(t){console.error(`Error loading container ${i}:`,t)}}}}var Fe=s(3390);class Le{constructor(e){(0,m.Z)(this,"_loader",void 0),(0,m.Z)(this,"name","MyTagsExtension"),(0,m.Z)(this,"enabled",!0),this._loader=e}loadNodeAsync(e,t,s){return this._loader.loadNodeAsync(e,t,(e=>{if(this._loader.gltf.meshes){const s=this._loader.gltf.meshes[t.mesh];s&&s.extras&&s.extras.tags&&u.Tags.AddTagsTo(e,s.extras.tags)}s(e)}))}dispose(){}}function Pe(){Fe.GLTFLoader.RegisterExtension("MyTagsExtension",(e=>new Le(e)))}class Me{constructor(){(0,m.Z)(this,"listCollisions",void 0),(0,m.Z)(this,"listCollisionsFloor",void 0),(0,m.Z)(this,"scene",void 0),this.scene=globalThis.scene,this.listCollisions=[],this.listCollisionsFloor=[],this.setCollisions()}setCollisions(){this.listCollisions=this.scene.meshes.filter((e=>e.checkCollisions||V.hasTag(e,"collision"))),this.listCollisionsFloor=this.scene.getMeshesByTags("ground"),this.listCollisions.forEach((e=>{e.isVisible=!1,e.isPickable=!0})),this.scene.getMeshesByTags("visible_force").forEach((e=>{e.isVisible=!0}))}static checkCollisionList(e,t){for(const s in t){const i=t[s];if(i!==e&&e.intersectsMesh(i,u.Tags.MatchesQuery(i,"precise")))return i}return!1}checkCollisionFloor(e){return Me.checkCollisionList(e,this.listCollisionsFloor)}appendCollisionByMeshes(e){e.forEach((e=>{(e.checkCollisions||V.hasTag(e,"collision"))&&(e.checkCollisions=!0,e.isVisible=!1,e.isPickable=!1,this.listCollisions.push(e))})),this.listCollisionsFloor=this.scene.getMeshesByTags("ground")}}var Be=s(106);class Ze{constructor(){(0,m.Z)(this,"items",void 0),(0,m.Z)(this,"scene",void 0),(0,m.Z)(this,"store",void 0),(0,m.Z)(this,"playerId",void 0),(0,m.Z)(this,"meshHead",void 0),(0,m.Z)(this,"meshFoot",void 0),(0,m.Z)(this,"showRay",void 0),(0,m.Z)(this,"rays",void 0),(0,m.Z)(this,"rectLabel",void 0),(0,m.Z)(this,"isFocused",void 0),(0,m.Z)(this,"currentPrefabId",void 0),this.scene=globalThis.scene,this.store=k,this.playerId=this.store.state.player.id,this.meshHead=this.scene.getMeshById("characterBody_"+this.playerId),this.meshFoot=this.scene.getMeshById("playerFoot_"+this.playerId),this.showRay=!1,this.items=[],this.rays=[],this.rectLabel=new Be.Ae,this.isFocused=!1,this.currentPrefabId=null,this.initItems(),this.initCastRays(),console.log(this.scene.getMeshesByTags("event_ice_meteor"))}initItems(){this.scene.getMeshesByTags("event_ice_meteor").forEach(((e,t)=>{if(e){console.log(e),e.isPickable=!1,e.isVisible=!1;const s=e.id+"_event_mesh_"+t,i=e.getBoundingInfo(),o=i.boundingBox.extendSize.scale(2),n=u.MeshBuilder.CreateBox(s,{height:o.y,width:o.x,depth:o.z},scene);n.parent=e,n.visibility=0,n.isVisible=!0;const a=this.getPrefabIdByMesh(e);if(a){const e=globalThis.prefabs.find((e=>e.id==a));e?(e.container.animationGroups.forEach((e=>{e.stop()})),this.items.push({meshEventId:s,prefabItem:e})):console.error("Not found prefabId")}else console.error("Not found prefabId")}}))}buildRays(){const e=.25,t=1,s=Math.round(t*t/(e*e));let i=0-(e+e/2);const o=i+t;let n=e+e/2,a=0;while(a<s){const s=i+e/2,r=n-t/2,h=1,l=new u.Ray(u.Vector3.Zero(),u.Vector3.Zero()),d=new u.RayHelper(l);d.attachToMesh(this.meshHead,new u.Vector3(s,r,h),new u.Vector3(0,.2,.2),h),this.showRay&&d.show(this.scene),i+=e,o<i+e&&(i=0-(e+e/2),n+=e),this.rays.push(l),a++}}castRay(e){const t=this.scene.pickWithRay(e),s=this.store.getters.getPlayerById(this.playerId);if(!s)return null;if(t&&t.pickedMesh){const e=t.pickedMesh,i=this.items.find((t=>t.meshEventId==e.id));if(i)return s.event.isFocused||(this.store.commit("SET_EVENT_IS_FOCUSED",{playerId:this.playerId,status:!0}),this.currentPrefabId=i.prefabItem.id,i.prefabItem.container.animationGroups.forEach((e=>{e.play(!0)}))),!0}if(s.event.isFocused&&(this.store.commit("SET_EVENT_IS_FOCUSED",{playerId:this.playerId,status:!1}),null!==this.currentPrefabId)){const e=this.items.find((e=>e.prefabItem.id==this.currentPrefabId));e&&e.prefabItem.container.animationGroups.forEach((e=>{e.stop()}))}return!1}castRays(){this.rays.forEach((e=>!this.castRay(e)))}initCastRays(){this.buildRays(),setInterval((()=>{this.castRays()}),100)}getPrefabIdByMesh(e){const t=e.parent?.parent;return t?Number(t.id.split("_")[1]):null}}class Ne{constructor(){(0,m.Z)(this,"players",void 0)}init(){globalThis.assetContainers=[],this.players=[];const e=document.getElementById("canvas");e.width=window.innerWidth,e.height=window.innerHeight;const t=new u.Engine(e,!0,{preserveDrawingBuffer:!1,stencil:!0}),s=new z(t),i=this.getPlayerId();k.commit("SET_SELF_PLAYER_ID",i),s.load((async()=>{new W,s.setEnvironment();const e=new q(i);e.init(),k.subscribe((t=>{"ADD_PLAYER"===t.type&&(t.payload.id===i?(new we(i),this.setClassesGame((()=>{k.commit("LOADING_TOGGLE"),console.info("Game loaded"),console.info("Self player "+i+" created")})),e.syncPlayer()):(this.players?.push(new Se(t.payload.id)),console.info("Player "+i+" created")))}))})),k.subscribe((e=>{if("REMOVE_PLAYER"===e.type){const t=this.players?.find((t=>t.playerId===e.payload));t&&(t.dispose(),console.info("Player "+t.playerId+" removed"))}}))}setClassesGame(e){Pe(),new X,globalThis.collisions=new Me,new Ce((()=>{e(),new Ze}))}getPlayerId(){const e=window.location.search,t=new URLSearchParams(e);let s=t.get("playerId");return s||(s="guest_"+(0,Ae.Z)()),s}}const Re={id:"top_bar",class:"no_focus_game"},Oe={id:"menu_button"};function xe(e,t,s,i,n,a){const r=(0,o.up)("meta-mask");return(0,o.wg)(),(0,o.iD)("div",Re,[(0,o._)("div",Oe,[(0,o._)("div",{class:"menu_button",onClick:t[0]||(t[0]=function(){return a.openMenu&&a.openMenu(...arguments)})})]),(0,o.Wm)(r)])}var De=s(3577);function ke(e,t,s,i,n,a){return(0,o.wg)(),(0,o.iD)("button",{onClick:t[0]||(t[0]=function(){return a.connectOrChangeWallet&&a.connectOrChangeWallet(...arguments)}),class:"wkit-button"},(0,De.zw)(n.isConnected?n.walletAddress.slice(0,6)+"..."+n.walletAddress.slice(-4):"Connect"),1)}var Ge=s(7918),Ue=s.n(Ge),Ve={data(){return{isConnected:!1,walletAddress:"",web3:null}},async created(){if(window.ethereum){this.web3=new(Ue())(window.ethereum);const e=await this.web3.eth.getAccounts();e.length>0&&(this.isConnected=!0,this.walletAddress=e[0]),window.ethereum.on("accountsChanged",(e=>{0===e.length?this.isConnected=!1:this.walletAddress=e[0]}))}else console.log("Metamask is not installed. Please consider installing it: https://metamask.io/download.html")},methods:{async connectOrChangeWallet(){if(window.ethereum)if(this.isConnected)this.isConnected=!1;else try{const e=await window.ethereum.request({method:"eth_requestAccounts"});this.isConnected=!0,this.walletAddress=e[0]}catch(e){console.error("User rejected connection:",e)}}}},ze=s(3744);const Ye=(0,ze.Z)(Ve,[["render",ke]]);var je=Ye,He={components:{MetaMask:je},methods:{openMenu(){this.$store.commit("SET_OPEN_MENU",!0)}}};const We=(0,ze.Z)(He,[["render",xe]]);var Je=We;const Ke={id:"level_preview"},$e={class:"container"},qe=(0,o._)("div",{class:"text"}," Are you ready? ",-1),Xe={class:"container_button"};function Qe(e,t,s,n,a,r){return(0,o.wy)(((0,o.wg)(),(0,o.iD)("div",Ke,[(0,o._)("div",$e,[qe,(0,o._)("div",Xe,[(0,o._)("button",{onClick:t[0]||(t[0]=function(){return e.play&&e.play(...arguments)}),class:"button"},"play")])])],512)),[[i.F8,!this.$store.state.level.loading&&this.show]])}var et=(0,o.aZ)({name:"LevelPreview",methods:{play(){this.$store.commit("SET_PLAY"),this.show=!1}},data(){return{show:!0}}});const tt=(0,ze.Z)(et,[["render",Qe]]);var st=tt;const it={id:"menu",class:"modal no_focus_game"},ot={class:"container"},nt={class:"content"},at=(0,o._)("div",{class:"title margin_bottom"},"Menu",-1),rt={class:"list"},ht=(0,o._)("li",null,[(0,o._)("a",{href:"/home"},"Exit")],-1),lt={class:"button_bar"};function dt(e,t,s,n,a,r){return(0,o.wy)(((0,o.wg)(),(0,o.iD)("div",it,[(0,o._)("div",ot,[(0,o._)("div",nt,[at,(0,o._)("ul",rt,[(0,o._)("li",null,[(0,o._)("a",{onClick:t[0]||(t[0]=function(){return e.openSettings&&e.openSettings(...arguments)})},"Settings")]),ht]),(0,o._)("div",lt,[(0,o._)("a",{onClick:t[1]||(t[1]=function(){return e.closeMenu&&e.closeMenu(...arguments)}),class:"button"},"Close")])])])],512)),[[i.F8,this.$store.state.level.isMenuOpen]])}var ct=(0,o.aZ)({methods:{closeMenu(){this.$store.commit("SET_OPEN_MENU",!1)},openSettings(){this.$store.commit("SET_SETTINGS_OPEN",!0)}}});const mt=(0,ze.Z)(ct,[["render",dt]]);var ut=mt;const pt={id:"settings",class:"modal no_focus_game"},yt={class:"container"},vt={class:"content"},gt=(0,o._)("div",{class:"title margin_bottom"},"Settings",-1),bt={class:"list"},ft=["onChange","checked"],It={class:"button_bar"};function Et(e,t,s,n,a,r){return(0,o.wy)(((0,o.wg)(),(0,o.iD)("div",pt,[(0,o._)("div",yt,[(0,o._)("div",vt,[gt,(0,o._)("ul",bt,[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(this.fields,((t,s)=>((0,o.wg)(),(0,o.iD)("li",{key:s},[(0,o._)("label",null,[(0,o._)("input",{type:"checkbox",onChange:s=>e.saveField(t.name,s),checked:t.value},null,40,ft),(0,o.Uk)(" "+(0,De.zw)(t.name),1)])])))),128))]),(0,o._)("div",It,[(0,o._)("a",{onClick:t[0]||(t[0]=function(){return e.close&&e.close(...arguments)}),class:"button"},"Close")])])])],512)),[[i.F8,this.$store.state.settings.open]])}var wt=(0,o.aZ)({name:"game-home",computed:{fields(){return this.$store.getters.settingFields}},methods:{saveField(e,t){this.$nextTick((()=>{this.$store.commit("SET_SETTING_FIELD_VALUE",{name:e,value:t.target.checked})}))},close(){this.$store.commit("SET_SETTINGS_OPEN",!1)}},data:function(){return{soundEnable:!0}}});const _t=(0,ze.Z)(wt,[["render",Et]]);var Tt=_t,St=(0,o.aZ)({name:"game-level",mounted(){this.$nextTick((()=>{const e=window.location.search,t=new URLSearchParams(e),s=t.get("level");this.$store.commit("SET_LEVEL",s||1);const i=new Ne;i.init()}))},computed:{...(0,p.Se)(["finish"])},watch:{finish(e){e&&(window.location.href="/finish")}},components:{TopBar:Je,LevelPreview:st,MenuLevel:ut,Settings:Tt}});const At=(0,ze.Z)(St,[["render",c],["__scopeId","data-v-340def46"]]);var Ct=At;(0,i.ri)(Ct).use(k).mount("#app")}},t={};function s(i){var o=t[i];if(void 0!==o)return o.exports;var n=t[i]={id:i,loaded:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.loaded=!0,n.exports}s.m=e,function(){var e=[];s.O=function(t,i,o,n){if(!i){var a=1/0;for(d=0;d<e.length;d++){i=e[d][0],o=e[d][1],n=e[d][2];for(var r=!0,h=0;h<i.length;h++)(!1&n||a>=n)&&Object.keys(s.O).every((function(e){return s.O[e](i[h])}))?i.splice(h--,1):(r=!1,n<a&&(a=n));if(r){e.splice(d--,1);var l=o();void 0!==l&&(t=l)}}return t}n=n||0;for(var d=e.length;d>0&&e[d-1][2]>n;d--)e[d]=e[d-1];e[d]=[i,o,n]}}(),function(){s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,{a:t}),t}}(),function(){s.d=function(e,t){for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){s.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e}}(),function(){var e={143:0};s.O.j=function(t){return 0===e[t]};var t=function(t,i){var o,n,a=i[0],r=i[1],h=i[2],l=0;if(a.some((function(t){return 0!==e[t]}))){for(o in r)s.o(r,o)&&(s.m[o]=r[o]);if(h)var d=h(s)}for(t&&t(i);l<a.length;l++)n=a[l],s.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return s.O(d)},i=self["webpackChunkbabylon_js"]=self["webpackChunkbabylon_js"]||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))}();var i=s.O(void 0,[998],(function(){return s(4158)}));i=s.O(i)})();
//# sourceMappingURL=app.126c89bb.js.map